@using EuroApi.Models
@model List<Match>
@{
    ViewBag.Title = "Index";
}
<div class="normalWrapper">
<div style="margin-bottom: 30px;">Choose group:<br />
    @Html.ActionLink("Overview", "Overview", "MatchResultBet")
    <a href="/MatchResultBet/Index?group=a">Group A</a>
    <a href="/MatchResultBet/Index?group=b">Group B</a>
    <a href="/MatchResultBet/Index?group=c">Group C</a>
    <a href="/MatchResultBet/Index?group=d">Group D</a>
</div>
<div class="userBetMatches">
    <div style="font-weight: bold; font-size: 1.5em; margin-bottom: 10px;">Group @Model.FirstOrDefault().HomeTeam.Group.Name</div>
    @foreach(var match in Model)
    {
        @Html.Partial("_UserBetMatch", match)
    }
</div>
<div class="groupTable">
    
</div><br />
<input type="button" onclick="removeAllUserBets();" value="Remove all bets" />
</div>
<script>
    $(document).ready(function () {
        $(".resultBet").on("change", function (event) {
            if (isNaN($(this).val()) || $(this).val() > 20) {
                $(this).val("0");
            }
            var parentDiv = $(this).parent();
            var homeGoals = parentDiv.find(".homeTeam").val();
            var awayGoals = parentDiv.find(".awayTeam").val();
            setBet($(this).attr("matchId"), homeGoals, awayGoals);
        });
    });

    function setBet(matchId, homeGoals, awayGoals) {
        $.ajax({
            type: 'POST',
            url: "/MatchResultBet/SetBet",
            data: {matchId: matchId, homeGoals: homeGoals, awayGoals: awayGoals, group: window.getURLParameter("group")},
            success: function (results) {
                console.log(results);
                outputGroup(results);
            }
        });
    }
    $.ajax({
        type: 'POST',
        url: "/MatchResultBet/GetTeamsInGroup",
        data: {group: window.getURLParameter("group")},
        success: function (results) {
            console.log(results);
            outputGroup(results);
        }
    });
    function getURLParameter(name) {
        return decodeURI(
            (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search) || [, null])[1]
        );
    }

    function outputGroup(results) {
        var html = "<table><tr><th style='width: 30px;'></th><th style='width: 70px;'>Team</th><th>#</th><th>+</th><th>-</th><th>+/-</th><th>P</th></tr>";
        for (var i = 0; i < results.length; i++ ) {
            var team = results[i];
            html += getTeamRow(team.Name, team.MatchCount, team.GoalsScored, team.GoalsConceded, team.GoalDifference, team.Points);
        }
        html += "</table>";
        $(".groupTable").html(html);

        function getTeamRow(teamName, matchCount, goalsScored, goalsConceded, goalDifference, points) {
            return "<tr><td><img src=/Content/flags/" + teamName + "-flag.gif style='height: 14px;' alt='flag' /></td><td>" + teamName + "</td><td>" + matchCount + "</td><td>" + goalsScored + "</td><td>" + goalsConceded + "</td><td>" + goalDifference + "</td><td>" + points + "</td></tr>";
        }
    }

    function removeAllUserBets() {
        $.ajax({
            type: 'POST',
            url: "/MatchResultBet/RemoveAllBets",
            data: { group: window.getURLParameter("group") },            
            success: function (results) {
                outputGroup(results);
                $(".resultBet").val("0");
            }
        });
    }	    
</script>